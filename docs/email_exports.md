Email Exports

This document summarizes all email flows currently implemented in the codebase.

DDT Email (PDF Allegato)
- Trigger: POST /ddt/{id}/send-email after DDT creation and photo upload.
- Content: HTML email with attached DDT PDF generated via pdf_service.genera_pdf_ddt.
- Recipients:
  - Cliente: clienti.email_amministrazione
  - Sede selezionata: sedi_cliente.email (if present)
  - Tecnico: utenti.email (tecnico che ha aperto il DDT)
  - Responsabile/i DDT: impostazioni_azienda.email_responsabile_ddt (lista separata da virgole)
  - Azienda: impostazioni_azienda.email
- Code references:
  - backend/app/main.py: send_ddt_email, send_email_ddt_background, get_ddt_email_recipients
  - frontend/src/pages/NewDDTPage.tsx: POST /ddt/{id}/send-email

DDT Reminder (Scheduler)
- Trigger: daily scheduler (09:00), only if ddt_alert_abilitato is true.
- Thresholds: ddt_alert_giorni_1, ddt_alert_giorni_2, ddt_alert_giorni_3.
- Content: HTML reminder with DDT number, days open, status, client, and pickup date.
- Recipients:
  - Tecnico: utenti.email
  - Responsabile/i DDT: impostazioni_azienda.email_responsabile_ddt (lista separata da virgole)
  - Azienda: impostazioni_azienda.email
- Code references:
  - backend/app/main.py: check_ddt_ritardi

Contract Expiration (Noleggio + Assistenza)
- Trigger: scheduler (Monday 09:00).
- Content: HTML notice with contract expiration details.
- Enabled by: contratti_alert_abilitato
- Thresholds: contratti_alert_giorni_1, contratti_alert_giorni_2, contratti_alert_giorni_3 (days before expiry).
- Recipients:
  - Azienda: impostazioni_azienda.contratti_alert_emails (lista separata da virgole)
  - Cliente: clienti.email_amministrazione
  - Sedi: sedi_cliente.email (where applicable)
- Code references:
  - backend/app/main.py: check_scadenze_contratti

Reading Copies Reminder (Printing)
- Trigger: daily scheduler (09:00).
- Content: HTML notice generated by generate_alert_letture_copie_email.
- Enabled by: letture_copie_alert_abilitato
- Thresholds: letture_copie_alert_giorni_1, letture_copie_alert_giorni_2, letture_copie_alert_giorni_3 (days before due).
- Recipients:
  - Azienda: impostazioni_azienda.letture_copie_alert_emails (lista separata da virgole)
- Code references:
  - backend/app/main.py: check_scadenze_letture_copie
  - backend/app/services/email_service.py: generate_alert_letture_copie_email

Backup Notifications
- Trigger: backup completion (success or failure).
- Enabled by: backup_alert_abilitato
- Recipients:
  - Azienda: impostazioni_azienda.backup_alert_emails (lista separata da virgole)
- Code references:
  - backend/app/services/backup_service.py: _send_backup_notification_email

RIT Email (PDF Allegato)
- Trigger: creation/update flows when a signed RIT is saved.
- Content: HTML email with attached RIT PDF.
- Recipients: depends on the specific RIT flow, typically client and internal recipients.
- Code references:
  - backend/app/main.py: send_email_background and its call sites
